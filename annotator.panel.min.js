(function(){var t=function(t,n){return function(){return t.apply(n,arguments)}},n={}.hasOwnProperty,e=function(t,e){function o(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t};Annotator.Plugin.Panel=function(n){function o(n,e){o.__super__.constructor.apply(this,arguments),this.applyTagsFilter=t(this.applyTagsFilter,this)}return e(o,n),o.prototype.events={".annotator-marginviewer-element .annotator-edit click":"onEditClick",".annotator-marginviewer-element .annotator-delete click":"onDeleteClick",annotationsLoaded:"onAnnotationsLoaded",annotationCreated:"onAnnotationCreated",".header-tool click":"switchMode","#search-annotation-text keyup":"searchByText",annotationDeleted:"onAnnotationDeleted",annotationUpdated:"onAnnotationUpdated",".annotator-viewer-delete mouseover":"onDeleteMouseover",".annotator-viewer-delete mouseout":"onDeleteMouseout",".annotator-marginviewer-element .annotator-save click":"submit",".annotator-marginviewer-element .annotator-cancel click":"clearEditors",".annotator-marginviewer-element .annotator-viewer click":"onClick",".annotator-marginviewer-element .annotator-viewer mouseover":"onMouseOver",".annotator-marginviewer-element .annotator-viewer mouseout":"onMouseOut","#annotations-panel click":"showHidePanel",rangeNormalizeFail:"collectFailedAnnotations"},o.prototype.ANNOTATIONS_ICON="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTguMS4xLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDQ5OS42OTYgNDk5LjY5NiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNDk5LjY5NiA0OTkuNjk2OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCI+CjxnPgoJPHBhdGggZD0iTTQxNS43MDMsMTEzLjYyMVYxNi4wNzhIMFYzMDcuNTJoODMuOTkzdjk3LjU0M2gyNzQuMjY2bDc4LjU1NSw3OC41NTV2LTc4LjU1NWg2Mi44ODNWMTEzLjYyMSAgIEg0MTUuNzAzeiBNODMuOTkzLDI5MS4yNjNIMTYuMjU3VjMyLjMzNWgzODMuMTg5djgxLjI4Nkg4My45OTNWMjkxLjI2M3ogTTQ4My40MzksMzg4LjgwNmgtNjIuODgzdjU1LjU2N2wtNTUuNTY3LTU1LjU2N0gxMDAuMjUgICBWMzA3LjUydi0xNi4yNTdWMTI5Ljg3OGgyOTkuMTk3aDE2LjI1N2g2Ny43MzVWMzg4LjgwNnoiIGZpbGw9IiMwMDAwMDAiLz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K",o.prototype.GLOBE_GRID="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTguMS4xLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDE1IDE1IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAxNSAxNTsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHdpZHRoPSIxNnB4IiBoZWlnaHQ9IjE2cHgiPgo8Zz4KCTxwYXRoIGQ9Ik0xNC45ODIsN0MxNC43MzYsMy4yNTYsMTEuNzQ0LDAuMjYzLDgsMC4wMTdWMEg3LjVIN3YwLjAxN0MzLjI1NiwwLjI2MywwLjI2MywzLjI1NiwwLjAxNyw3SDB2MC41ICAgVjhoMC4wMTdDMC4yNjMsMTEuNzQ0LDMuMjU2LDE0LjczNiw3LDE0Ljk4MlYxNWgwLjVIOHYtMC4wMThjMy43NDQtMC4yNDYsNi43MzYtMy4yMzgsNi45ODItNi45ODJIMTVWNy41VjdIMTQuOTgyeiBNNC42OTUsMS42MzUgICBDNC4yMTIsMi4yNzcsMy44MTEsMy4wODIsMy41MTksNEgyLjAyMUMyLjY3MywyLjk4MywzLjU5OSwyLjE2LDQuNjk1LDEuNjM1eiBNMS40OTgsNWgxLjc1OEMzLjEyMiw1LjYzMiwzLjAzNyw2LjMwMywzLjAxLDdIMS4wMTkgICBDMS4wNzIsNi4yOTYsMS4yMzgsNS42MjMsMS40OTgsNXogTTEuMDE5LDhIMy4wMWMwLjAyNywwLjY5NywwLjExMiwxLjM2OCwwLjI0NiwySDEuNDk4QzEuMjM4LDkuMzc3LDEuMDcyLDguNzA0LDEuMDE5LDh6ICAgIE0yLjAyMSwxMWgxLjQ5N2MwLjI5MiwwLjkxOCwwLjY5MywxLjcyMywxLjE3NywyLjM2NUMzLjU5OSwxMi44NCwyLjY3MywxMi4wMTgsMi4wMjEsMTF6IE03LDEzLjkzNiAgIEM1Ljk3MiwxMy42NjEsNS4wODcsMTIuNTU3LDQuNTUsMTFIN1YxMy45MzZ6IE03LDEwSDQuMjY5QzQuMTI4LDkuMzc3LDQuMDM5LDguNzA0LDQuMDEsOEg3VjEweiBNNyw3SDQuMDEgICBjMC4wMjktMC43MDQsMC4xMTgtMS4zNzcsMC4yNTktMkg3Vjd6IE03LDRINC41NUM1LjA4NywyLjQ0Myw1Ljk3MiwxLjMzOSw3LDEuMDY1VjR6IE0xMi45NzksNGgtMS40OTYgICBjLTAuMjkzLTAuOTE4LTAuNjkzLTEuNzIzLTEuMTc4LTIuMzY1QzExLjQsMi4xNiwxMi4zMjcsMi45ODMsMTIuOTc5LDR6IE04LDEuMDY1QzkuMDI3LDEuMzM5LDkuOTEzLDIuNDQzLDEwLjQ1LDRIOFYxLjA2NXogTTgsNSAgIGgyLjczYzAuMTQyLDAuNjIzLDAuMjI5LDEuMjk2LDAuMjYsMkg4VjV6IE04LDhoMi45OWMtMC4wMjksMC43MDQtMC4xMTgsMS4zNzctMC4yNiwySDhWOHogTTgsMTMuOTM2VjExaDIuNDUgICBDOS45MTMsMTIuNTU3LDkuMDI3LDEzLjY2MSw4LDEzLjkzNnogTTEwLjMwNSwxMy4zNjVjMC40ODMtMC42NDMsMC44ODUtMS40NDcsMS4xNzgtMi4zNjVoMS40OTYgICBDMTIuMzI3LDEyLjAxOCwxMS40LDEyLjg0LDEwLjMwNSwxMy4zNjV6IE0xMy41MDIsMTBoLTEuNzU4YzAuMTM0LTAuNjMyLDAuMjE5LTEuMzAzLDAuMjQ2LTJoMS45OSAgIEMxMy45MjgsOC43MDQsMTMuNzYyLDkuMzc3LDEzLjUwMiwxMHogTTExLjk5LDdjLTAuMDI3LTAuNjk3LTAuMTEyLTEuMzY4LTAuMjQ2LTJoMS43NThjMC4yNiwwLjYyMywwLjQyNiwxLjI5NiwwLjQ3OSwySDExLjk5eiIgZmlsbD0iIzAwMDAwMCIvPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=",o.prototype.CAUTION="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTguMS4xLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDI3Ljk2MyAyNy45NjMiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDI3Ljk2MyAyNy45NjM7IiB4bWw6c3BhY2U9InByZXNlcnZlIiB3aWR0aD0iMTZweCIgaGVpZ2h0PSIxNnB4Ij4KPGc+Cgk8ZyBpZD0iYzEyOV9leGNsYW1hdGlvbiI+CgkJPHBhdGggZD0iTTEzLjk4MywwQzYuMjYxLDAsMC4wMDEsNi4yNTksMC4wMDEsMTMuOTc5YzAsNy43MjQsNi4yNiwxMy45ODQsMTMuOTgyLDEzLjk4NHMxMy45OC02LjI2MSwxMy45OC0xMy45ODQgICAgQzI3Ljk2Myw2LjI1OSwyMS43MDUsMCwxMy45ODMsMHogTTEzLjk4MywyNi41MzFjLTYuOTMzLDAtMTIuNTUtNS42Mi0xMi41NS0xMi41NTNjMC02LjkzLDUuNjE3LTEyLjU0OCwxMi41NS0xMi41NDggICAgYzYuOTMxLDAsMTIuNTQ5LDUuNjE4LDEyLjU0OSwxMi41NDhDMjYuNTMxLDIwLjkxMSwyMC45MTMsMjYuNTMxLDEzLjk4MywyNi41MzF6IiBmaWxsPSIjMDAwMDAwIi8+CgkJPHBvbHlnb24gcG9pbnRzPSIxNS41NzksMTcuMTU4IDE2LjE5MSw0LjU3OSAxMS44MDQsNC41NzkgMTIuNDE0LDE3LjE1OCAgICIgZmlsbD0iIzAwMDAwMCIvPgoJCTxwYXRoIGQ9Ik0xMy45OTgsMTguNTQ2Yy0xLjQ3MSwwLTIuNSwxLjAyOS0yLjUsMi41MjZjMCwxLjQ0MywwLjk5OSwyLjUyOCwyLjQ0NCwyLjUyOGgwLjA1NmMxLjQ5OSwwLDIuNDY5LTEuMDg1LDIuNDY5LTIuNTI4ICAgIEMxNi40NDEsMTkuNTc1LDE1LjQ2OCwxOC41NDYsMTMuOTk4LDE4LjU0NnoiIGZpbGw9IiMwMDAwMDAiLz4KCTwvZz4KCTxnIGlkPSJDYXBhXzFfMjA3XyI+Cgk8L2c+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPC9zdmc+Cg==",o.prototype.BACK="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA0OTIgNDkyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA0OTIgNDkyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCI+CjxnPgoJPGc+CgkJPHBhdGggZD0iTTE5OC42MDgsMjQ2LjEwNEwzODIuNjY0LDYyLjA0YzUuMDY4LTUuMDU2LDcuODU2LTExLjgxNiw3Ljg1Ni0xOS4wMjRjMC03LjIxMi0yLjc4OC0xMy45NjgtNy44NTYtMTkuMDMybC0xNi4xMjgtMTYuMTIgICAgQzM2MS40NzYsMi43OTIsMzU0LjcxMiwwLDM0Ny41MDQsMHMtMTMuOTY0LDIuNzkyLTE5LjAyOCw3Ljg2NEwxMDkuMzI4LDIyNy4wMDhjLTUuMDg0LDUuMDgtNy44NjgsMTEuODY4LTcuODQ4LDE5LjA4NCAgICBjLTAuMDIsNy4yNDgsMi43NiwxNC4wMjgsNy44NDgsMTkuMTEybDIxOC45NDQsMjE4LjkzMmM1LjA2NCw1LjA3MiwxMS44Miw3Ljg2NCwxOS4wMzIsNy44NjRjNy4yMDgsMCwxMy45NjQtMi43OTIsMTkuMDMyLTcuODY0ICAgIGwxNi4xMjQtMTYuMTJjMTAuNDkyLTEwLjQ5MiwxMC40OTItMjcuNTcyLDAtMzguMDZMMTk4LjYwOCwyNDYuMTA0eiIgZmlsbD0iIzAwMDAwMCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=",o.prototype.viewer=null,o.prototype.plugins=[],o.prototype.editor=null,o.prototype.failedAnnotations=[],o.prototype.pageAnnotations=[],o.prototype.globalAnnotations=[],o.prototype.mode="page",o.prototype.options={storage:null},o.prototype.loadGlobalAnnotations=null,o.prototype.storage,o.prototype.tagsFilter=null,o.prototype.textFilter=null,o.prototype.tags=[],o.prototype.pluginInit=function(){if(Annotator.supported()){if(jQuery("body").append(this.createAnnotationPanel()),this.editor=new PanelEditor,this.editor.addField(this.annotator.editor.fields[0]),this.viewer=new PanelViewer,this.viewer.addField(this.annotator.viewer.fields[0]),this.addTextFilter(),this.options.storage&&(jQuery('<img class="header-tool" data-mode="global" src='+this.GLOBE_GRID+" />").appendTo(".annotations-panel-tools"),this.storageAnnotations(this.options.storage)),this.annotator.plugins.Tags){var t=new Annotator.Plugin.Tags(this.annotator.element[0]);t.annotator=this,this.plugins.push(t),t.pluginInit(),this.options.storage&&this.addTagsFilter(this.options.storage)}if(this.annotator.plugins.Permissions){var n=new Annotator.Plugin.Permissions(this.annotator.element[0],jQuery.extend(this.annotator.plugins.Permissions.options,{user:this.annotator.plugins.Permissions.user}));n.annotator=this,this.plugins.push(n),n.pluginInit()}}},o.prototype.storageAnnotations=function(t){return"Offline"==t?(t=new Annotator.Plugin.Offline.Store,this.loadGlobalAnnotations=function(){this.globalAnnotations=this.storage.all(),this.emptyList(),this.populateList(this.globalAnnotations)}):"Store"==t&&(t=new Annotator.Plugin.Store,this.loadGlobalAnnotations=function(){this.storage._apiRequest("read",null,function(t){null==t&&(t=[]),this.globalAnnotations=t,this.emptyList(),this.populateList(this.globalAnnotations)})}),this.storage=t},o.prototype.switchMode=function(t){switch(jQuery(t.currentTarget).data("mode")){case"global":this.loadGlobalAnnotations(),jQuery(".header-tool,.counter-failed").toggle("slide"),this.mode="global",this.unbindAnnotatorSelections();break;case"failed":this.emptyList(),this.populateList(this.failedAnnotations),jQuery(".header-tool,.counter-failed").toggle("slide"),this.mode="failed",this.unbindAnnotatorSelections();break;case"page":this.emptyList(),this.populateList(this.pageAnnotations),jQuery(".header-tool,.counter-failed").toggle("slide"),this.mode="page",this.bindAnnotatorSelections()}},o.prototype.unbindAnnotatorSelections=function(){jQuery(document).unbind({mouseup:this.annotator.checkForEndSelection,mousedown:this.annotator.checkForStartSelection})},o.prototype.sortAnnotations=function(t){return t=t.sort(function(t,n){return t.created_at-n.created_at})},o.prototype.bindAnnotatorSelections=function(){jQuery(document).bind({mouseup:this.annotator.checkForEndSelection,mousedown:this.annotator.checkForStartSelection})},o.prototype.emptyList=function(){jQuery("li").remove(".annotator-marginviewer-element"),jQuery("#count-anotations").text(0)},o.prototype.collectFailedAnnotations=function(t,n,e){this.failedAnnotations.push(t)},o.prototype.showHidePanel=function(){jQuery(".annotations-panel-header").toggle("slide"),jQuery("#anotacions-uoc-panel").toggle("slide")},o.prototype.clearEditors=function(){Annotator.Util.preventEventDefault(event);var t=this;jQuery(".annotator-marginviewer-element .annotator-editor").each(function(){t.viewer.load(jQuery(this).parent().data("annotation")),jQuery(this).replaceWith(t.viewer.element.clone())})},o.prototype.onDeleteClick=function(t){t.stopPropagation();var n=jQuery(t.currentTarget).closest(".annotator-marginviewer-element").data("annotation");this.annotator.deleteAnnotation(n)},o.prototype.submit=function(){Annotator.Util.preventEventDefault(event),this.editor.submit(),this.annotator.updateAnnotation(this.editor.annotation)},o.prototype.onEditClick=function(t){t.stopPropagation(),this.clearEditors();var n=jQuery(t.currentTarget).closest(".annotator-marginviewer-element").data("annotation");this.editor.load(n),jQuery(t.currentTarget).closest(".annotator-viewer").replaceWith(this.editor.element)},o.prototype.onAnnotationCreated=function(t){this.tagsFilter&&this.tagsFilter.val([]).change(),this.textFilter.val(""),this.searchByText(),this.createReferenceAnnotation(t),this.pageAnnotations.push(t),jQuery("#count-anotations").text(jQuery(".container-anotacions").find(".annotator-marginviewer-element").length)},o.prototype.onAnnotationUpdated=function(t){this.viewer.load(t),jQuery("#annotation-"+t.id).empty().append(this.viewer.element.clone()),jQuery("#annotation-"+t.id).data("annotation",t)},o.prototype.getIdsArray=function(t){var n=[];return jQuery.each(t,function(){n.push(this.id)}),n},o.prototype.differentiateLoadedAnnotations=function(t){var n=[],e=[],o=[],i=[];return jQuery.each(t,function(){e.push(this.id)}),jQuery.each(this.failedAnnotations,function(){n.push(this.id)}),o=jQuery.grep(e,function(t){return jQuery.inArray(t,n)<0}),jQuery.each(t,function(){jQuery.inArray(this.id,o)>=0&&i.push(this)}),i},o.prototype.onAnnotationsLoaded=function(t){this.failedAnnotations.length&&jQuery('<img class="header-tool" data-mode="failed" src='+this.CAUTION+' /><span class="counter-failed">'+this.failedAnnotations.length+"</span>").appendTo(".annotations-panel-tools");this.pageAnnotations=this.differentiateLoadedAnnotations(t),this.populateList(this.pageAnnotations)},o.prototype.populateList=function(t){if((t=this.sortAnnotations(t)).length>0)for(i=0,len=t.length;i<len;i++)annotation=t[i],this.createReferenceAnnotation(annotation);jQuery("#count-anotations").text(jQuery(".container-anotacions").find(".annotator-marginviewer-element").length),this.tagsFilter&&this.applyTagsFilter(),this.searchByText()},o.prototype.onAnnotationDeleted=function(t){jQuery(".annotator-marginviewer-element").remove("#annotation-"+t.id),jQuery("#count-anotations").text(jQuery(".container-anotacions").find(".annotator-marginviewer-element").length)},o.prototype.createAnnotationPanel=function(t){var n='<span  class="annotations-panel-expander" title="View annotations" ><img src="'+this.ANNOTATIONS_ICON+'" ><br><span class="label-counter" id="count-anotations">0</span></span>';return'<div  class="annotations-list-uoc"><div class="annotations-panel-header"><div class="annotations-panel-tools"><img class="header-tool" data-mode="page" src='+this.BACK+' /></div><div class="annotations-panel-filters"></div></div><div id="annotations-panel">'+n+'</div><div id="anotacions-uoc-panel" ><ul class="container-anotacions"></ul></div></div>'},o.prototype.uniqId=function(){return(""+Math.random()+(new Date).getTime()).slice(2)},o.prototype.createReferenceAnnotation=function(t){if(!jQuery("#annotation-"+t.id).length){var n=null;null!=t.id?n="annotation-"+t.id:(n=t.id=this.uniqId(),n="annotation-"+t.id),this.viewer.load(t),jQuery('<li class="annotator-marginviewer-element" id="'+n+'"></li>').data("annotation",t).append(this.viewer.element.clone()).prependTo(".container-anotacions")}},o.prototype.onClick=function(t){if("failed"!=this.mode){var n=jQuery(t.currentTarget).closest(".annotator-marginviewer-element").data("annotation"),e=this.isOnPage(n.id);if(e.length){var o=jQuery(window).height();jQuery("html, body").animate({scrollTop:e[0].offset().top-o/2},2e3)}else window.location=decodeURIComponent(n.page)}},o.prototype.onMouseOver=function(t){var n=jQuery(t.currentTarget).closest(".annotator-marginviewer-element").data("annotation"),e=this.isOnPage(n.id);e.length&&jQuery.each(e,function(){this.addClass("annotator-hl-temporary")})},o.prototype.onMouseOut=function(t){var n=jQuery(t.currentTarget).closest(".annotator-marginviewer-element").data("annotation"),e=this.isOnPage(n.id);e.length&&jQuery.each(e,function(){this.removeClass("annotator-hl-temporary")})},o.prototype.isOnPage=function(t){var n=[];return jQuery(".annotator-hl").each(function(){jQuery(this).data("annotation").id==t&&n.push(jQuery(this))}),n},PanelEditor=function(){this.annotation={},this.element=jQuery('<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+Annotator._t("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+Annotator._t("Save")+"</a>\n    </div>\n  </form>\n</div>"),this.fields=[]},PanelEditor.prototype.load=function(t){var n,e,o,i;for(this.annotation=t,e=0,o=(i=this.fields).length;e<o;e++)(n=i[e]).load(n.element,this.annotation)},PanelEditor.prototype.submit=function(t){var n,e,o,i;for(Annotator.Util.preventEventDefault(t),e=0,o=(i=this.fields).length;e<o;e++)(n=i[e]).submit(n.element,this.annotation)},PanelEditor.prototype.setElement=function(t){this.element=t},PanelEditor.prototype.addField=function(t){var n,e,o;switch(e=jQuery.extend({id:"annotator-field-"+Annotator.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},t),o=null,n=jQuery('<li class="annotator-item" />'),e.element=n[0],e.type){case"textarea":o=jQuery("<textarea />");break;case"input":case"checkbox":o=jQuery("<input />");break;case"select":o=jQuery("<select />")}return n.append(o),o.attr({id:e.id,placeholder:e.label}),"checkbox"===e.type&&(o[0].type="checkbox",n.addClass("annotator-checkbox"),n.append(jQuery("<label />",{for:e.id,html:e.label}))),this.element.find("ul:first").append(n),this.fields.push(e),e.element},PanelViewer=function(){this.element=null,this.fields=[]},PanelViewer.prototype.options={readOnly:!1},PanelViewer.prototype.load=function(t){var t,n,e,o,i,a,r,s,l,u,c,M=jQuery('<div class="annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>'),g=jQuery('<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>');for(s=M.find("ul"),e=(r=g.clone().appendTo(s).data("annotation",t)).find(".annotator-controls"),i=e.find(".annotator-edit"),o=e.find(".annotator-delete"),this.options.readOnly?(i.remove(),o.remove()):n={showEdit:function(){return i.removeAttr("disabled")},hideEdit:function(){return i.attr("disabled","disabled")},showDelete:function(){return o.removeAttr("disabled")},hideDelete:function(){return o.attr("disabled","disabled")}},l=0,u=(c=this.fields).length;l<u;l++)a=c[l],fieldelement=jQuery(a.element).appendTo(r)[0],a.load(fieldelement,t,n);return this.element=M},PanelViewer.prototype.addField=function(t){var n;return n=jQuery.extend({load:function(){}},t),n.element=jQuery("<div />")[0],this.fields.push(n),n.element,this},o.prototype.addTextFilter=function(){jQuery(".annotations-panel-filters").append('<div class="panel-filters" id="panel-text-filter"></div>');var t=jQuery('<input id="search-annotation-text" placeholder="Search by text"/>');t.appendTo("#panel-text-filter"),this.textFilter=t},o.prototype.searchByText=function(){var t="annotator-marginviewer-element-textfilter-hide",n=this.textFilter.val(),e=this;jQuery(".annotator-marginviewer-element").each(function(){n?e.textFilterCheck(n,jQuery(this).data("annotation").text)?jQuery(this).removeClass(t):jQuery(this).addClass(t):jQuery(this).removeClass(t)}),jQuery("#count-anotations").text(this.countAnnotationsAfterFilter())},o.prototype.textFilterCheck=function(t,n){var e,o,i,a;if(!t||!n)return!1;for(o=0,i=(a=t.split(/\s+/)).length;o<i;o++)if(e=a[o],-1===n.toLowerCase().indexOf(e.toLowerCase()))return!1;return!0},o.prototype.addTagsFilter=function(t){if(this.storage){jQuery(".annotations-panel-filters").append('<div class="panel-filters" id="panel-tags-filter"></div>');var n=jQuery('<select id="select-annotation-tags" multiple></select>');if(n.appendTo("#panel-tags-filter"),this.tagsFilter=n,"Offline"==t){annotations=this.storage.all();var e=this.getTags(annotations);this.initializeTagsFilter(e)}else"Store"==t&&this.storage._apiRequest("read",null,function(t){null==t&&(t=[]);var n=this.getTags(t);this.initializeTagsFilter(n)})}},o.prototype.getTags=function(t){var n,e=[];for(n=0;n<t.length;n++)e=e.concat(t[n].tags);return jQuery.unique(e)},o.prototype.initializeTagsFilter=function(t){for(var n=0;n<t.length;n++)this.tagsFilter.append('<option value="'+t[n]+'">'+t[n]+"</option>");this.tagsFilter.select2({width:"288px",placeholder:"Search by tag"}).on("change",this.applyTagsFilter)},o.prototype.applyTagsFilter=function(){var t="annotator-marginviewer-element-tagsfilter-hide",n=this.tagsFilter.val(),e=this;jQuery(".annotator-marginviewer-element").each(function(){n?e.checkIfFiltered(jQuery(this).data("annotation").tags,n)?jQuery(this).removeClass(t):jQuery(this).addClass(t):jQuery(this).removeClass(t)}),jQuery("#count-anotations").text(this.countAnnotationsAfterFilter())},o.prototype.checkIfFiltered=function(t,n){return jQuery.grep(t,function(t){return jQuery.inArray(t.toString(),n)>=0}).length==n.length},o.prototype.countAnnotationsAfterFilter=function(){return jQuery(".annotator-marginviewer-element:not(.annotator-marginviewer-element-textfilter-hide):not(.annotator-marginviewer-element-tagsfilter-hide)").length},o}(Annotator.Plugin)}).call(this);